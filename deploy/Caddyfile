# Seth's instance
seth.64-23-141-85.nip.io {
	# Upload endpoints (used by Control UI script, no separate auth needed)
	handle /upload {
		reverse_proxy localhost:3456
	}
	handle /upload-button.js {
		reverse_proxy localhost:3456
	}
	handle /files/* {
		reverse_proxy localhost:3456
	}

	# Protected content routes — require OAuth session
	handle /workspace/* {
		forward_auth localhost:4180 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://seth.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		uri strip_prefix /workspace
		root * /home/clawdbot/clawd
		file_server browse
	}
	handle /preview/* {
		forward_auth localhost:4180 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://seth.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		root * /opt/preview
		rewrite * /index.html
		file_server
	}
	handle /canvas/ {
		forward_auth localhost:4180 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://seth.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		root * /opt
		rewrite * /canvas-gallery.html
		file_server
	}
	handle /canvas/* {
		forward_auth localhost:4180 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://seth.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		uri strip_prefix /canvas
		root * /home/clawdbot/clawd/canvas
		file_server
	}
	handle /browse/* {
		forward_auth localhost:4180 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://seth.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		reverse_proxy localhost:8090
	}

	# Default: ClawdBot UI through oauth2-proxy
	handle {
		reverse_proxy localhost:4180
	}
}

# Curtis's instance
curtis.64-23-141-85.nip.io {
	handle /upload {
		reverse_proxy localhost:3457
	}
	handle /upload-button.js {
		reverse_proxy localhost:3457
	}
	handle /files/* {
		reverse_proxy localhost:3457
	}

	# Protected content routes — require OAuth session
	handle /workspace/* {
		forward_auth localhost:4182 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://curtis.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		uri strip_prefix /workspace
		root * /home/clawdbot-curtis/clawd
		file_server browse
	}
	handle /preview/* {
		forward_auth localhost:4182 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://curtis.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		root * /opt/preview
		rewrite * /index.html
		file_server
	}
	handle /canvas/ {
		forward_auth localhost:4182 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://curtis.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		root * /opt
		rewrite * /canvas-gallery.html
		file_server
	}
	handle /canvas/* {
		forward_auth localhost:4182 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://curtis.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		uri strip_prefix /canvas
		root * /home/clawdbot-curtis/clawd/canvas
		file_server
	}
	handle /browse/* {
		forward_auth localhost:4182 {
			uri /oauth2/auth
			header_up X-Forwarded-Uri {uri}
			copy_headers X-Auth-Request-User X-Auth-Request-Email
			@unauthorized status 401
			handle_response @unauthorized {
				redir https://curtis.64-23-141-85.nip.io/oauth2/start?rd={uri} 302
			}
		}
		reverse_proxy localhost:8091
	}

	# Default: ClawdBot UI through oauth2-proxy
	handle {
		reverse_proxy localhost:4182
	}
}

# Original domain redirects to Seth's instance
64-23-141-85.nip.io {
	handle {
		redir https://seth.64-23-141-85.nip.io{uri} permanent
	}
	header X-DO-MARKETPLACE clawdbot
}

64-23-141-85.nip.io:8443 {
	reverse_proxy localhost:4181
	header X-DO-MARKETPLACE clawdbot
}

64.23.141.85 {
	redir https://seth.64-23-141-85.nip.io{uri} permanent
}
